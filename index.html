<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kurnik</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Dodane biblioteki do generowania PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 960px;
        }
        .chicken-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .chicken-card:hover {
            transform: scale(1.03);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .chicken-card .image-wrapper {
            position: relative;
            width: 150px;
            height: 150px;
            margin-bottom: 1rem;
            overflow: hidden;
            border-radius: 0.5rem;
            border: 2px solid #d1d5db;
        }
        .chicken-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .chicken-card img:hover {
            transform: scale(1.05);
        }
        .deceased-card {
            filter: grayscale(80%);
            opacity: 0.7;
            border: 2px solid #e5e7eb;
        }
        .deceased-card:hover {
            transform: none;
            box-shadow: none;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 1rem;
        }
        .close-button {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
        }
        .close-button:hover,
        .close-button:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }
        /* Style dla przycisku PDF */
        .download-btn {
          background: linear-gradient(90deg, #3b82f6, #10b981);
          color: white;
          font-weight: 600;
          padding: 0.75rem 1.5rem;
          border-radius: 9999px;
          transition: transform 0.2s, box-shadow 0.2s;
        }
        .download-btn:hover {
          transform: scale(1.05);
          box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        /* Klasa do ukrycia elementu w widoku PDF */
        .hide-on-pdf {
            display: none !important;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4 sm:p-8">

    <!-- Nagłówek -->
    <header class="w-full text-center py-8">
        <h1 class="text-4xl font-bold text-gray-800">Kurnik 🐔</h1>
        <p class="text-xl text-gray-600 mt-2">Lista kur</p>
        <!-- Przycisk do pobierania PDF -->
        <button id="download-pdf" class="download-btn mt-6">📄 Pobierz listę jako PDF</button>
    </header>

    <!-- Statystyki -->
    <div class="w-full container bg-white rounded-xl shadow-lg p-6 sm:p-8 mb-8 flex flex-wrap justify-between items-center text-center">
        <div class="flex-1 min-w-[120px] p-2">
            <p class="text-4xl font-bold text-blue-600" id="total-count">0</p>
            <p class="text-gray-500">Razem</p>
        </div>
        <div class="flex-1 min-w-[120px] p-2">
            <p class="text-4xl font-bold text-green-600" id="chicken-count">0</p>
            <p class="text-gray-500">Kury</p>
        </div>
        <div class="flex-1 min-w-[120px] p-2">
            <p class="text-4xl font-bold text-red-600" id="rooster-count">0</p>
            <p class="text-gray-500">Koguty</p>
        </div>
    </div>

    <!-- Lista kur - zawartość będzie generowana dynamicznie przez JavaScript -->
    <main id="pdf-content" class="w-full container bg-white rounded-xl shadow-lg p-6 sm:p-8 mb-8">
        <h2 class="text-2xl font-bold text-gray-700 mb-4">Aktualna lista</h2>
        <!-- Pole wyszukiwania - dodano klasę do ukrycia w PDF -->
        <div class="mb-6">
            <input type="text" id="search-input" placeholder="Wyszukaj po imieniu, gatunku lub dacie urodzenia..." class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div id="chicken-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
            <!-- Tutaj zostaną wstawione karty kur i kogutów po załadowaniu strony -->
        </div>
    </main>

    <!-- Sekcja dla kur, które odeszły -->
    <section class="w-full container bg-white rounded-xl shadow-lg p-6 sm:p-8 mt-4">
        <h2 class="text-2xl font-bold text-gray-700 mb-4">Kury lub koguty, które odeszły 😔</h2>
        <div id="deceased-chicken-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
            <!-- Tutaj zostaną wstawione karty zmarłych kur -->
        </div>
    </section>

    <!-- Modal do powiększania zdjęć -->
    <div id="imageModal" class="modal">
        <span class="close-button" onclick="closeModal()">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>

    <!-- Skrypty JavaScript -->
    <script>
        // Funkcja do otwierania modalu
        function openModal(imageElement) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            
            modal.style.display = 'flex';
            modalImage.src = imageElement.src;
        }

        // Funkcja do zamykania modalu
        function closeModal() {
            const modal = document.getElementById('imageModal');
            modal.style.display = 'none';
        }

        // Zamykanie modalu po kliknięciu poza zdjęciem
        window.onclick = function(event) {
            const modal = document.getElementById('imageModal');
            if (event.target == modal) {
                closeModal();
            }
        }

        // Dane o kurach i kogutach - teraz przechowywane w JS
        const allChickens = [
            { name: "Kogut Lucjan", species: "Rosa Jarzębata", dob: "1 Lipiec 2024", ringNumber: "000", image: "https://placehold.co/150x150/e2e8f0/000000?text=Lucjan" },
            { name: "Kogut Henio", species: "Czarny typ włoszka Kogut", dob: "24 Czerwiec 2025", ringNumber: "Nieznane", image: "https://placehold.co/150x150/e2e8f0/000000?text=Henio" },
            { name: "Mariolcia", species: "Liliputki Polskie", dob: "Czerwiec/Lipiec 2025", ringNumber: "Nieznane", image: "https://placehold.co/150x150/e2e8f0/000000?text=Mariolcia" },
            { name: "Gabrysia", species: "Liliputki Polskie", dob: "Czerwiec/Lipiec 2025", ringNumber: "Nieznane", image: "https://placehold.co/150x150/e2e8f0/000000?text=Gabrysia" },
            { name: "Kogut Benio", species: "Liliputki Polskie", dob: "Czerwiec/Lipiec 2025", ringNumber: "Nieznane", image: "https://placehold.co/150x150/e2e8f0/000000?text=Benio" },
            { name: "Edzia", species: "Rosa Karmazyn z Zielonymi nóżkami", dob: "24 Czerwiec 2025", ringNumber: "Nieznane", image: "https://placehold.co/150x150/e2e8f0/000000?text=Edzia" },
            { name: "Kogut Albert", species: "Perliczki", dob: "Maj/Czerwiec 2025", ringNumber: "Nieznane", image: "https://placehold.co/150x150/e2e8f0/000000?text=Albert" },
            { name: "Miecia", species: "Perliczki", dob: "Maj/Czerwiec 2025", ringNumber: "Nieznane", image: "https://placehold.co/150x150/e2e8f0/000000?text=Miecia" },
            { name: "Melania", species: "Perliczki", dob: "Maj/Czerwiec 2025", ringNumber: "Nieznane", image: "https://placehold.co/150x150/e2e8f0/000000?text=Melania" },
            { name: "Halińcia", species: "Rosa Lawendowa", dob: "1 Lipiec 2024", ringNumber: "Nieznane", image: "https://placehold.co/150x150/e2e8f0/000000?text=Halincia" },
            { name: "Tereska", species: "Zielononóżka Kuropatwiana", dob: "1 Lipiec 2024", ringNumber: "Nieznane", image: "https://placehold.co/150x150/e2e8f0/000000?text=Tereska" },
            { name: "Danuta", species: "Rosa Bląd z zielonymi nóżkami", dob: "1 Lipiec 2024", ringNumber: "Nieznane", image: "https://placehold.co/150x150/e2e8f0/000000?text=Danuta" },
            { name: "Tekla", species: "Czerwona Rosa", dob: "Kwiecień 2023", ringNumber: "Nieznane", image: "https://placehold.co/150x150/e2e8f0/000000?text=Tekla" },
            { name: "Czesia", species: "Rosa Czerwona", dob: "ok. Marzec 2021", ringNumber: "Nieznane", image: "https://placehold.co/150x150/e2e8f0/000000?text=Czesia" },
            { name: "Fredzia", species: "Rosa Czerwona", dob: "Marzec 2020", ringNumber: "Nieznane", image: "https://placehold.co/150x150/e2e8f0/000000?text=Fredzia" },
            { name: "Jadzia", species: "Lenhorn", dob: "Nieznane (ok. 2016/2017)", ringNumber: "Nieznane", image: "https://placehold.co/150x150/e2e8f0/000000?text=Jadzia" },
            { name: "Celina", species: "Rosa Czerwona", dob: "Marzec 2020", ringNumber: "Nieznane", image: "https://placehold.co/150x150/e2e8f0/000000?text=Celina" },
        ];

        // Dane o kurach, które odeszły
        const deceasedChickens = [
            { name: "Nieznany Kogut", species: "Nieznane", dob: "Nieznane", dateOfDeath: "Nieznane", ringNumber: "Nieznane", image: "https://placehold.co/150x150/e2e8f0/000000?text=Przykład" },
            { name: "Nieznany kura", species: "Nieznane", dob: "Nieznane", dateOfDeath: "Nieznane", ringNumber: "Nieznane", image: "https://placehold.co/150x150/e2e8f0/000000?text=Przykład" }
        ];
        
        // Tablica do mapowania polskich nazw miesięcy na liczby
        const monthMap = {
            "Styczeń": 0, "Luty": 1, "Marzec": 2, "Kwiecień": 3, "Maj": 4, "Czerwiec": 5,
            "Lipiec": 6, "Sierpień": 7, "Wrzesień": 8, "Październik": 9, "Listopad": 10, "Grudzień": 11
        };
        
        let sortedChickens = []; // Global variable to store the initial sorted list

        /**
         * Parses a Polish date string into a Date object.
         * Handles formats like "1 Lipiec 2024", "Maj/Czerwiec 2025", "Nieznane".
         * For unknown dates, it returns a very large timestamp to place them at the end.
         * For month ranges, it takes the first month.
         * @param {string} dateStr The date string to parse.
         * @returns {Date} A Date object representing the date.
         */
        function parseDate(dateStr) {
            // Check for unknown date, return a very old date to put it at the end
            if (dateStr.includes("Nieznane")) {
                return new Date(0); // A very early timestamp
            }

            // Remove "ok." prefix if present
            dateStr = dateStr.replace("ok. ", "");

            // Handle date with day, month, and year (e.g., "1 Lipiec 2024")
            let parts = dateStr.split(" ");
            if (parts.length >= 3) {
                let day = parseInt(parts[0]);
                let month = monthMap[parts[1]];
                let year = parseInt(parts[2]);
                if (!isNaN(day) && month !== undefined && !isNaN(year)) {
                    return new Date(year, month, day);
                }
            }

            // Handle date with just month and year (e.g., "Kwiecień 2023")
            if (parts.length >= 2) {
                let month = monthMap[parts[0]];
                let year = parseInt(parts[1]);
                if (month !== undefined && !isNaN(year)) {
                    return new Date(year, month, 1);
                }
            }

            // Handle date with month range (e.g., "Maj/Czerwiec 2025")
            let monthRangeParts = dateStr.split("/");
            if (monthRangeParts.length >= 2) {
                let firstMonth = monthMap[monthRangeParts[0]];
                let year = parseInt(monthRangeParts[1].split(" ")[1]);
                if (firstMonth !== undefined && !isNaN(year)) {
                    return new Date(year, firstMonth, 1);
                }
            }
            
            // If all parsing fails, return a very early date
            console.error("Failed to parse date string:", dateStr);
            return new Date(0);
        }

        /**
         * Renders the chicken cards into the DOM.
         * @param {Array<Object>} chickens The array of chicken objects to render.
         * @param {string} containerId The ID of the container element.
         * @param {boolean} isDeceased Whether the chickens are deceased.
         */
        function renderChickens(chickens, containerId, isDeceased = false) {
            const container = document.getElementById(containerId);
            if (!container) return; // Prevent errors if container not found
            container.innerHTML = ''; // Clear existing content

            if (chickens.length === 0 && !isDeceased) {
                container.innerHTML = `<p class="text-center text-gray-500 col-span-full">Brak pasujących kur lub kogutów.</p>`;
            }

            // Update counts for the main list
            if (!isDeceased) {
                const totalCount = chickens.length;
                const chickenCount = chickens.filter(c => !c.isRooster).length;
                const roosterCount = totalCount - chickenCount;

                document.getElementById('total-count').innerText = totalCount;
                document.getElementById('chicken-count').innerText = chickenCount;
                document.getElementById('rooster-count').innerText = roosterCount;
            }
            
            chickens.forEach(chicken => {
                const card = document.createElement('div');
                card.className = `chicken-card bg-gray-50 rounded-lg p-4 shadow-sm ${isDeceased ? 'deceased-card' : ''}`;
                
                let dobOrDeathInfo = `<p class="text-gray-600"><span class="font-bold">Data urodzenia:</span> ${chicken.dob}</p>`;
                if (isDeceased) {
                    dobOrDeathInfo = `<p class="text-gray-600"><span class="font-bold">Data urodzenia:</span> ${chicken.dob}<br><span class="font-bold">Data śmierci:</span> ${chicken.dateOfDeath}</p>`;
                }

                card.innerHTML = `
                    <div class="image-wrapper">
                        <img src="${chicken.image}" alt="${chicken.name}" onclick="openModal(this)">
                    </div>
                    <h3 class="text-2xl font-semibold text-gray-900">${chicken.name}</h3>
                    <p class="text-gray-600 mt-1">
                        <span class="font-bold">Gatunek:</span> ${chicken.species}
                    </p>
                    ${dobOrDeathInfo}
                    <p class="text-gray-600">
                        <span class="font-bold">Nr. obrączki:</span> ${chicken.ringNumber}
                    </p>
                `;
                container.appendChild(card);
            });
        }

        /**
         * Filters the chicken list based on the search input.
         */
        function filterChickens() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const filteredChickens = sortedChickens.filter(chicken => {
                const nameMatch = chicken.name.toLowerCase().includes(query);
                const speciesMatch = chicken.species.toLowerCase().includes(query);
                const dobMatch = chicken.dob.toLowerCase().includes(query);
                return nameMatch || speciesMatch || dobMatch;
            });
            renderChickens(filteredChickens, 'chicken-list');
        }
        
        /**
         * Generates a multi-page PDF from the main content section, with page breaks, header, and footer.
         */
        async function generatePDF() {
            const doc = new window.jspdf.jsPDF("p", "mm", "a4");
            const pdfWidth = doc.internal.pageSize.getWidth();
            const pdfHeight = doc.internal.pageSize.getHeight();
            const margin = 10;
            let pageNumber = 1;
            
            // Get current counts from the main app
            const totalCount = document.getElementById('total-count').innerText;
            const chickenCount = document.getElementById('chicken-count').innerText;
            const roosterCount = document.getElementById('rooster-count').innerText;

            const chickenList = document.getElementById('chicken-list');
            const chickenCards = Array.from(chickenList.children);
            const cardsPerPage = 12;

            // Function to add header to a page
            const addHeader = (pageNumber) => {
                doc.setFontSize(13);
                doc.text(`Aktualna lista: ${totalCount} `, margin, margin + 5);
                doc.text(`Razem: ${totalCount} Kury: ${chickenCount}, Koguty: ${roosterCount}`, margin, margin + 12);
                doc.line(margin, margin + 15, pdfWidth - margin, margin + 15);
            };

            // Function to add footer to a page
            const addFooter = (pageNumber) => {
                doc.setFontSize(10);
                doc.text(`Generator PDF opracowany przez — O5K4R_ TECHNOLOGIC | Strona nr. ${pageNumber}`, pdfWidth - margin, pdfHeight - margin - 2, { align: 'right' });
            };

            // Loop through the cards and generate pages
            for (let i = 0; i < chickenCards.length; i += cardsPerPage) {
                // If not the first page, add a new one
                if (i > 0) {
                    doc.addPage();
                    pageNumber++;
                }

                // Add header and footer to the new page
                addHeader(pageNumber);
                addFooter(pageNumber);

                // Create a temporary container for the cards on this page
                const tempDiv = document.createElement('div');
                tempDiv.style.display = 'grid';
                tempDiv.style.gridTemplateColumns = 'repeat(3, minmax(0, 1fr))';
                tempDiv.style.gap = '24px';
                tempDiv.style.padding = '0 10px'; // Matching the left/right margin

                const cardsForPage = chickenCards.slice(i, i + cardsPerPage);
                cardsForPage.forEach(card => tempDiv.appendChild(card.cloneNode(true)));
                
                document.body.appendChild(tempDiv);
                
                const canvas = await html2canvas(tempDiv, { scale: 2 });
                const imgData = canvas.toDataURL("image/jpeg");
                const imgProps = doc.getImageProperties(imgData);
                const imgHeight = (imgProps.height * (pdfWidth - 2 * margin)) / imgProps.width;

                // Add the image to the PDF, below the header
                doc.addImage(imgData, 'JPEG', margin, margin + 20, pdfWidth - 2 * margin, imgHeight);

                // Clean up the temporary div
                document.body.removeChild(tempDiv);
            }

            doc.save("kurnik-lista.pdf");
        }


        // Sortowanie i renderowanie kart po załadowaniu DOM
        window.addEventListener('DOMContentLoaded', (event) => {
            // Dodajemy pole `isRooster` i `parsedDob` do każdego obiektu, aby ułatwić sortowanie
            sortedChickens = allChickens.map(chicken => {
                return {
                    ...chicken,
                    isRooster: chicken.name.toLowerCase().includes('kogut'),
                    parsedDob: parseDate(chicken.dob)
                };
            });

            // Główne sortowanie
            sortedChickens.sort((a, b) => {
                // Koguty zawsze na początku, sortowanie według daty od najstarszych do najmłodszych
                if (a.isRooster && b.isRooster) {
                    return a.parsedDob.getTime() - b.parsedDob.getTime();
                }
                if (a.isRooster && !b.isRooster) {
                    return -1;
                }
                if (!a.isRooster && b.isRooster) {
                    return 1;
                }
                // Kury sortowane od najmłodszych do najstarszych
                return b.parsedDob.getTime() - a.parsedDob.getTime();
            });

            // Renderuj posortowane karty
            renderChickens(sortedChickens, 'chicken-list');
            
            // Renderuj karty zmarłych kur
            renderChickens(deceasedChickens, 'deceased-chicken-list', true);
            
            // Dodaj nasłuchiwanie na pole wyszukiwania
            document.getElementById('search-input').addEventListener('input', filterChickens);

            // Dodaj nasłuchiwanie na przycisk pobierania PDF
            document.getElementById('download-pdf').addEventListener('click', generatePDF);
        });
    </script>
</body>
</html>




