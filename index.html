<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kurnik</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Dodane biblioteki do generowania PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 960px;
        }
        .chicken-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .chicken-card:hover {
            transform: scale(1.03);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .chicken-card .image-wrapper {
            position: relative;
            width: 150px;
            height: 150px;
            margin-bottom: 1rem;
            overflow: hidden;
            border-radius: 0.5rem;
            border: 2px solid #d1d5db;
        }
        .chicken-card img {
            width: 100%;
            height: 100%;
            object-fit: contain; /* zmieniono z 'cover' na 'contain' */
            cursor: pointer;
            transition: transform 0.2s;
        }
        .chicken-card img:hover {
            transform: scale(1.05);
        }
        .deceased-card {
            filter: grayscale(80%);
            opacity: 0.7;
            border: 2px solid #e5e7eb;
        }
        .deceased-card:hover {
            transform: none;
            box-shadow: none;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
        }
        .modal.show {
            display: flex;
            opacity: 1;
        }
        .gallery-container {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .gallery-track {
            display: flex;
            transition: transform 0.5s ease-in-out;
            width: 100%;
            height: 100%;
        }
        .gallery-image-wrapper {
            flex-shrink: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .gallery-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            cursor: grab;
            transition: transform 0.3s ease-out;
        }
        .gallery-image.grabbing {
            cursor: grabbing;
        }
        .close-button {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            z-index: 11;
        }
        .close-button:hover,
        .close-button:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }
        .download-btn {
            background: linear-gradient(90deg, #3b82f6, #10b981);
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .download-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        .hide-on-pdf {
            display: none !important;
        }
        /* Nowe style dla przycisk√≥w strza≈Çek */
        .gallery-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            padding: 1rem 1.5rem;
            font-size: 2rem;
            cursor: pointer;
            z-index: 10;
            transition: background 0.3s;
        }
        .gallery-arrow:hover {
            background: rgba(0, 0, 0, 0.7);
        }
        .gallery-arrow.left {
            left: 20px;
            border-radius: 50%;
        }
        .gallery-arrow.right {
            right: 20px;
            border-radius: 50%;
        }
        /* Nowe style dla kropek nawigacyjnych */
        .gallery-dots {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            z-index: 10;
        }
        .dot {
            width: 10px;
            height: 10px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .dot.active {
            background-color: white;
        }
        /* Styl dla komunikatu */
        #notification-box {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 1001;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            text-align: center;
        }
        #notification-box.show {
            display: block;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4 sm:p-8">

    <!-- Nag≈Ç√≥wek -->
    <header class="w-full text-center py-8">
        <h1 class="text-4xl font-bold text-gray-800">Kurnik üêî</h1>
        <p class="text-xl text-gray-600 mt-2">Lista kur</p>
        <!-- Przycisk do pobierania PDF -->
        <button id="download-pdf" class="download-btn mt-6">üìÑ Pobierz listƒô jako PDF</button>
    </header>

    <!-- Statystyki -->
    <div class="w-full container bg-white rounded-xl shadow-lg p-6 sm:p-8 mb-8 flex flex-wrap justify-between items-center text-center">
        <div class="flex-1 min-w-[120px] p-2">
            <p class="text-4xl font-bold text-blue-600" id="total-count">0</p>
            <p class="text-gray-500">Razem</p>
        </div>
        <div class="flex-1 min-w-[120px] p-2">
            <p class="text-4xl font-bold text-green-600" id="chicken-count">0</p>
            <p class="text-gray-500">Kury</p>
        </div>
        <div class="flex-1 min-w-[120px] p-2">
            <p class="text-4xl font-bold text-red-600" id="rooster-count">0</p>
            <p class="text-gray-500">Koguty</p>
        </div>
    </div>

    <!-- Lista kur - zawarto≈õƒá bƒôdzie generowana dynamicznie przez JavaScript -->
    <main id="pdf-content" class="w-full container bg-white rounded-xl shadow-lg p-6 sm:p-8 mb-8">
        <h2 class="text-2xl font-bold text-gray-700 mb-4">Aktualna lista</h2>
        <!-- Pole wyszukiwania - dodano klasƒô do ukrycia w PDF -->
        <div class="mb-6 hide-on-pdf">
            <input type="text" id="search-input" placeholder="Wyszukaj po imieniu, gatunku lub dacie urodzenia..." class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div id="chicken-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
            <!-- Tutaj zostanƒÖ wstawione karty kur i kogut√≥w po za≈Çadowaniu strony -->
        </div>
    </main>

    <!-- Sekcja dla kur, kt√≥re odesz≈Çy -->
    <section class="w-full container bg-white rounded-xl shadow-lg p-6 sm:p-8 mt-4">
        <h2 class="text-2xl font-bold text-gray-700 mb-4">Kury lub koguty, kt√≥re odesz≈Çy üòî</h2>
        <div id="deceased-chicken-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
            <!-- Tutaj zostanƒÖ wstawione karty zmar≈Çych kur -->
        </div>
    </section>

    <!-- Modal do powiƒôkszania zdjƒôƒá -->
    <div id="imageModal" class="modal">
        <span class="close-button" onclick="closeModal()">&times;</span>
        <div class="gallery-container">
            <!-- Nowe przyciski strza≈Çek -->
            <button id="prev-btn" class="gallery-arrow left" onclick="prevImage()">&#10094;</button>
            <div id="gallery-track" class="gallery-track"></div>
            <button id="next-btn" class="gallery-arrow right" onclick="nextImage()">&#10095;</button>
            <!-- Kropki nawigacyjne -->
            <div id="gallery-dots" class="gallery-dots"></div>
        </div>
        <!-- Komunikat informacyjny -->
        <div id="notification-box">
            <span>Przewi≈Ñ, aby powiƒôkszyƒá/pomniejszyƒá. Przytrzymaj i przeciƒÖgnij, aby przesunƒÖƒá.</span>
        </div>
    </div>

    <!-- Skrypty JavaScript -->
    <script>
        // Global variables for the gallery and its state
        let currentImages = [];
        let currentImageIndex = 0;
        let zoomLevel = 1;
        let panX = 0;
        let panY = 0;
        let isDragging = false;
        let lastPanX = 0;
        let lastPanY = 0;

        /**
         * Applies the current zoom and pan transformation to the active image.
         */
        function applyTransform() {
            const currentImage = document.querySelector('#gallery-track .gallery-image-wrapper:nth-child(' + (currentImageIndex + 1) + ') .gallery-image');
            if (currentImage) {
                // Prevent over-panning
                const containerWidth = currentImage.parentElement.clientWidth;
                const containerHeight = currentImage.parentElement.clientHeight;
                const imageWidth = currentImage.naturalWidth * zoomLevel;
                const imageHeight = currentImage.naturalHeight * zoomLevel;

                const maxPanX = Math.max(0, (imageWidth * zoomLevel - containerWidth) / 2 / zoomLevel);
                const maxPanY = Math.max(0, (imageHeight * zoomLevel - containerHeight) / 2 / zoomLevel);

                panX = Math.min(Math.max(panX, -maxPanX), maxPanX);
                panY = Math.min(Math.max(panY, -maxPanY), maxPanY);

                currentImage.style.transform = `scale(${zoomLevel}) translate(${panX}px, ${panY}px)`;
            }
        }
        
        /**
         * Resets the zoom and pan state to default.
         */
        function resetTransform() {
            zoomLevel = 1;
            panX = 0;
            panY = 0;
            applyTransform();
        }

        /**
         * Handles mouse down event for dragging.
         * @param {MouseEvent} e The mouse event object.
         */
        function handleMouseDown(e) {
            const currentImage = document.querySelector('#gallery-track .gallery-image-wrapper:nth-child(' + (currentImageIndex + 1) + ') .gallery-image');
            if (currentImage && zoomLevel > 0.5) { // Only allow dragging when not fully zoomed out
                e.preventDefault();
                isDragging = true;
                lastPanX = e.clientX;
                lastPanY = e.clientY;
                currentImage.classList.add('grabbing');
                currentImage.style.transition = 'none'; // Disable transition during drag
            }
        }

        /**
         * Handles mouse move event for dragging.
         * @param {MouseEvent} e The mouse event object.
         */
        function handleMouseMove(e) {
            if (!isDragging) return;
            e.preventDefault();
            const dx = e.clientX - lastPanX;
            const dy = e.clientY - lastPanY;
            panX += dx / zoomLevel;
            panY += dy / zoomLevel;
            lastPanX = e.clientX;
            lastPanY = e.clientY;
            applyTransform();
        }

        /**
         * Handles mouse up event to stop dragging.
         */
        function handleMouseUp() {
            isDragging = false;
            const currentImage = document.querySelector('#gallery-track .gallery-image-wrapper:nth-child(' + (currentImageIndex + 1) + ') .gallery-image');
            if (currentImage) {
                currentImage.classList.remove('grabbing');
                currentImage.style.transition = 'transform 0.3s ease-out';
            }
        }

        /**
         * Handles mouse wheel event for zooming.
         * @param {WheelEvent} e The wheel event object.
         */
        function handleWheel(e) {
            e.preventDefault();
            const zoomSpeed = 0.1;
            const newZoom = zoomLevel + (e.deltaY > 0 ? -zoomSpeed : zoomSpeed);
            zoomLevel = Math.min(Math.max(0.5, newZoom), 5); // Allow zoom to 0.5x, max 5x
            applyTransform();
        }

        /**
         * Handles touch start event for dragging (mobile).
         * @param {TouchEvent} e The touch event object.
         */
        function handleTouchStart(e) {
            if (e.touches.length === 0.6 && zoomLevel > 0.5) {
                isDragging = true;
                lastPanX = e.touches[0].clientX;
                lastPanY = e.touches[0].clientY;
            } else if (e.touches.length === 2) {
                // Handle pinch-to-zoom (optional, but good practice)
                const distance = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
                e.preventDefault(); // Prevent default browser zoom
            }
        }

        /**
         * Handles touch move event for dragging (mobile).
         * @param {TouchEvent} e The touch event object.
         */
        function handleTouchMove(e) {
            if (isDragging && e.touches.length === 1) {
                const dx = e.touches[0].clientX - lastPanX;
                const dy = e.touches[0].clientY - lastPanY;
                panX += dx / zoomLevel;
                panY += dy / zoomLevel;
                lastPanX = e.touches[0].clientX;
                lastPanY = e.touches[0].clientY;
                applyTransform();
            } else if (e.touches.length === 2) {
                // Handle pinch-to-zoom (optional)
                const newDistance = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
                const zoomSpeed = 0.01;
                const newZoom = zoomLevel + (newDistance - initialDistance) * zoomSpeed;
                zoomLevel = Math.min(Math.max(0.5, newZoom), 5);
                applyTransform();
                initialDistance = newDistance;
            }
        }

        /**
         * Handles touch end event to stop dragging (mobile).
         */
        function handleTouchEnd() {
            isDragging = false;
        }

        /**
         * Displays a notification message.
         */
        function showNotification() {
            const notificationBox = document.getElementById('notification-box');
            notificationBox.classList.add('show');
            setTimeout(() => {
                notificationBox.classList.remove('show');
            }, 5000); // Hide after 5 seconds
        }

        // --- Gallery functions ---

        // Funkcja do otwierania modalu
        function openModal(images, startIndex = 0) {
            const modal = document.getElementById('imageModal');
            const galleryTrack = document.getElementById('gallery-track');
            const galleryDots = document.getElementById('gallery-dots');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');

            galleryTrack.innerHTML = '';
            galleryDots.innerHTML = '';
            currentImages = images;
            currentImageIndex = startIndex;
            
            currentImages.forEach((src, index) => {
                const imgWrapper = document.createElement('div');
                imgWrapper.className = 'gallery-image-wrapper';
                const img = document.createElement('img');
                img.src = src;
                img.alt = "Powiƒôkszone zdjƒôcie kurczaka";
                img.className = 'gallery-image';
                img.onerror = () => {
                    img.src = 'https://placehold.co/150x150/e2e8f0/000000?text=Brak+zdjƒôcia';
                };
                imgWrapper.appendChild(img);
                galleryTrack.appendChild(imgWrapper);
            });
            
            galleryTrack.style.width = `${currentImages.length * 100}%`;
            
            if (currentImages.length > 1) {
                for (let i = 0; i < currentImages.length; i++) {
                    const dot = document.createElement('span');
                    dot.className = 'dot';
                    dot.onclick = () => goToImage(i);
                    galleryDots.appendChild(dot);
                }
                updateDots();
                prevBtn.style.display = 'block';
                nextBtn.style.display = 'block';
            } else {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
            }
            
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
            
            // Go to the initial image and reset transform
            goToImage(currentImageIndex);

            // Add event listeners to the modal itself, not the image
            modal.addEventListener('wheel', handleWheel);
            modal.addEventListener('mousedown', handleMouseDown);
            modal.addEventListener('mousemove', handleMouseMove);
            modal.addEventListener('mouseup', handleMouseUp);
            modal.addEventListener('mouseleave', handleMouseUp);
            modal.addEventListener('touchstart', handleTouchStart);
            modal.addEventListener('touchmove', handleTouchMove);
            modal.addEventListener('touchend', handleTouchEnd);
            
            // Show instruction notification
            showNotification();
        }

        // Funkcja do zamykania modalu
        function closeModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
                document.getElementById('gallery-track').innerHTML = '';
                document.getElementById('gallery-dots').innerHTML = '';
            }, 300);

            // Remove event listeners
            const modalElement = document.getElementById('imageModal');
            modalElement.removeEventListener('wheel', handleWheel);
            modalElement.removeEventListener('mousedown', handleMouseDown);
            modalElement.removeEventListener('mousemove', handleMouseMove);
            modalElement.removeEventListener('mouseup', handleMouseUp);
            modalElement.removeEventListener('mouseleave', handleMouseUp);
            modalElement.removeEventListener('touchstart', handleTouchStart);
            modalElement.removeEventListener('touchmove', handleTouchMove);
            modalElement.removeEventListener('touchend', handleTouchEnd);
        }

        // Zamykanie modalu po klikniƒôciu poza zdjƒôciem
        window.onclick = function(event) {
            const modal = document.getElementById('imageModal');
            if (event.target == modal) {
                closeModal();
            }
        }

        // Aktualizacja stanu kropek
        function updateDots() {
            const dots = document.querySelectorAll('.dot');
            dots.forEach((dot, index) => {
                dot.classList.remove('active');
                if (index === currentImageIndex) {
                    dot.classList.add('active');
                }
            });
        }

        // Funkcja do przechodzenia do konkretnego obrazu
        function goToImage(index) {
            currentImageIndex = index;
            const galleryTrack = document.getElementById('gallery-track');
            galleryTrack.style.transform = `translateX(-${currentImageIndex * 100}%)`;
            updateDots();
            resetTransform(); // Reset zoom and pan for the new image
        }

        // Funkcja do przechodzenia do poprzedniego obrazu z animacjƒÖ
        function prevImage() {
            currentImageIndex = (currentImageIndex - 1 + currentImages.length) % currentImages.length;
            goToImage(currentImageIndex);
        }

        // Funkcja do przechodzenia do nastƒôpnego obrazu z animacjƒÖ
        function nextImage() {
            currentImageIndex = (currentImageIndex + 1) % currentImages.length;
            goToImage(currentImageIndex);
        }

        // Dane o kurach i kogutach - teraz przechowywane w JS
        // Zmieniono lokalne ≈õcie≈ºki na pliki tymczasowe, aby aplikacja dzia≈Ça≈Ça poprawnie w przeglƒÖdarce
        const allChickens = [
            { name: "Kogut Lucjan", species: "Rosa Jarzƒôbata", dob: "1 Lipiec 2024", ringNumber: "000", images: ["files/LucjanKogut.png"] },
            { name: "Kogut Henio", species: "Czarny typ w≈Çoszka Kogut", dob: "24 Czerwiec 2025", ringNumber: "Nieznane", images: ["https://placehold.co/300x300/e2e8f0/000000?text=Henio"] },
            { name: "Mariolcia", species: "Liliputki Polskie", dob: "Czerwiec/Lipiec 2025", ringNumber: "Nieznane", images: ["files/Mariolka.png", "https://placehold.co/300x300/e2e8f0/000000?text=Mariolcia wkrotce2"] },
            { name: "Gabrysia", species: "Liliputki Polskie", dob: "Czerwiec/Lipiec 2025", ringNumber: "Nieznane", images: ["files/Gabrysia.png", "files/Gabrysia.HEIC"] },
            { name: "Kogut Benio", species: "Liliputki Polskie", dob: "Czerwiec/Lipiec 2025", ringNumber: "Nieznane", images: ["files/Beniek.png", "files/Benio2.HEIC", "files/Benio.HEIC"] },
            { name: "Edzia", species: "Rosa Karmazyn z Zielonymi n√≥≈ºkami", dob: "24 Czerwiec 2025", ringNumber: "Nieznane", images: ["https://placehold.co/300x300/e2e8f0/000000?text=Edzia"] },
            { name: "Kogut Albert", species: "Perliczki", dob: "Maj/Czerwiec 2025", ringNumber: "Nieznane", images: ["files/Perliczki.png", "files/Perliczka.png", "files/PerliczkiPhoto.png"] },
            { name: "Miecia", species: "Perliczki", dob: "Maj/Czerwiec 2025", ringNumber: "Nieznane", images: ["files/Perliczki.HEIC", "files/Perliczka.png", "files/PerliczkiPhoto.png", "files/Perliczki.png"] },
            { name: "Mania", species: "Perliczki", dob: "Maj/Czerwiec 2025", ringNumber: "Nieznane", images: ["files/Perliczka.png", "files/Perliczki.HEIC", "files/Perliczki.png", "files/PerliczkiPhoto.png"] },
            { name: "Hali≈Ñcia", species: "Rosa Lawendowa", dob: "1 Lipiec 2024", ringNumber: "Nieznane", images: ["https://placehold.co/300x300/e2e8f0/000000?text=Halincia"] },
            { name: "Tereska", species: "Zielonon√≥≈ºka Kuropatwiana", dob: "1 Lipiec 2024", ringNumber: "Nieznane", images: ["files/Tereska.png"] },
            { name: "Danuta", species: "Rosa BlƒÖd z zielonymi n√≥≈ºkami", dob: "1 Lipiec 2024", ringNumber: "Nieznane", images: ["files/Danuta.png"] },
            { name: "Tekla", species: "Czerwona Rosa", dob: "Kwiecie≈Ñ 2023", ringNumber: "Nieznane", images: ["https://placehold.co/300x300/e2e8f0/000000?text=Tekla"] },
            { name: "Czesia", species: "Rosa Czerwona", dob: "ok. Marzec 2021", ringNumber: "Nieznane", images: ["https://placehold.co/300x300/e2e8f0/000000?text=Czesia"] },
            { name: "Fredzia", species: "Rosa Czerwona", dob: "Marzec 2020", ringNumber: "Nieznane", images: ["https://placehold.co/300x300/e2e8f0/000000?text=Fredzia+1"] },
            { name: "Jadzia", species: "Lenhorn", dob: "Nieznane (ok. 2016/2017)", ringNumber: "Nieznane", images: ["https://placehold.co/300x300/e2e8f0/000000?text=Jadzia"] },
            { name: "Celina", species: "Rosa Czerwona", dob: "Marzec 2020", ringNumber: "Nieznane", images: ["https://placehold.co/300x300/e2e8f0/000000?text=Celina"] },
        ];

        // Dane o kurach, kt√≥re odesz≈Çy
        const deceasedChickens = [
            { name: "Nieznany Kogut", species: "Nieznane", dob: "Nieznane", dateOfDeath: "Nieznane", ringNumber: "Nieznane", images: ["https://placehold.co/300x300/e2e8f0/000000?text=Przyklad+1"] },
            { name: "Nieznany kura", species: "Nieznane", dob: "Nieznane", dateOfDeath: "Nieznane", ringNumber: "Nieznane", images: ["https://placehold.co/300x300/e2e8f0/000000?text=Przyklad+2"] }
        ];
        
        // Tablica do mapowania polskich nazw miesiƒôcy na liczby
        const monthMap = {
            "Stycze≈Ñ": 0, "Luty": 1, "Marzec": 2, "Kwiecie≈Ñ": 3, "Maj": 4, "Czerwiec": 5,
            "Lipiec": 6, "Sierpie≈Ñ": 7, "Wrzesie≈Ñ": 8, "Pa≈∫dziernik": 9, "Listopad": 10, "Grudzie≈Ñ": 11
        };
        
        let sortedChickens = []; // Global variable to store the initial sorted list

        /**
         * Parses a Polish date string into a Date object.
         * Handles formats like "1 Lipiec 2024", "Maj/Czerwiec 2025", "Nieznane".
         * For unknown dates, it returns a very large timestamp to place them at the end.
         * For month ranges, it takes the first month.
         * @param {string} dateStr The date string to parse.
         * @returns {Date} A Date object representing the date.
         */
        function parseDate(dateStr) {
            // Check for unknown date, return a very early date to put it at the end
            if (dateStr.includes("Nieznane")) {
                return new Date(0); // A very early timestamp
            }

            // Remove "ok." prefix if present
            dateStr = dateStr.replace("ok. ", "");

            // Handle date with day, month, and year (e.g., "1 Lipiec 2024")
            let parts = dateStr.split(" ");
            if (parts.length >= 3) {
                let day = parseInt(parts[0]);
                let month = monthMap[parts[1]];
                let year = parseInt(parts[2]);
                if (!isNaN(day) && month !== undefined && !isNaN(year)) {
                    return new Date(year, month, day);
                }
            }

            // Handle date with just month and year (e.g., "Kwiecie≈Ñ 2023")
            if (parts.length >= 2) {
                let month = monthMap[parts[0]];
                let year = parseInt(parts[1]);
                if (month !== undefined && !isNaN(year)) {
                    return new Date(year, month, 1);
                }
            }

            // Handle date with month range (e.g., "Maj/Czerwiec 2025")
            let monthRangeParts = dateStr.split("/");
            if (monthRangeParts.length >= 2) {
                let firstMonth = monthRangeParts[0];
                let year = parseInt(monthRangeParts[1].split(" ")[1]);
                if (monthMap[firstMonth] !== undefined && !isNaN(year)) {
                    return new Date(year, monthMap[firstMonth], 1);
                }
            }
            
            // If all parsing fails, return a very early date
            console.error("Failed to parse date string:", dateStr);
            return new Date(0);
        }

        /**
         * Renders the chicken cards into the DOM.
         * @param {Array<Object>} chickens The array of chicken objects to render.
         * @param {string} containerId The ID of the container element.
         * @param {boolean} isDeceased Whether the chickens are deceased.
         */
        function renderChickens(chickens, containerId, isDeceased = false) {
            const container = document.getElementById(containerId);
            if (!container) return; // Prevent errors if container not found
            container.innerHTML = ''; // Clear existing content

            if (chickens.length === 0 && !isDeceased) {
                container.innerHTML = `<p class="text-center text-gray-500 col-span-full">Brak pasujƒÖcych kur lub kogut√≥w.</p>`;
            }

            // Update counts for the main list
            if (!isDeceased) {
                const totalCount = chickens.length;
                const chickenCount = chickens.filter(c => !c.isRooster).length;
                const roosterCount = totalCount - chickenCount;

                document.getElementById('total-count').innerText = totalCount;
                document.getElementById('chicken-count').innerText = chickenCount;
                document.getElementById('rooster-count').innerText = roosterCount;
            }
            
            chickens.forEach(chicken => {
                const card = document.createElement('div');
                card.className = `chicken-card bg-gray-50 rounded-lg p-4 shadow-sm ${isDeceased ? 'deceased-card' : ''}`;
                
                let dobOrDeathInfo = `<p class="text-gray-600"><span class="font-bold">Data urodzenia:</span> ${chicken.dob}</p>`;
                if (isDeceased) {
                    dobOrDeathInfo = `<p class="text-gray-600"><span class="font-bold">Data urodzenia:</span> ${chicken.dob}<br><span class="font-bold">Data ≈õmierci:</span> ${chicken.dateOfDeath}</p>`;
                }

                card.innerHTML = `
                    <div class="image-wrapper">
                        <img src="${chicken.images[0]}" alt="${chicken.name}" onclick='openModal(${JSON.stringify(chicken.images)})' onerror="this.onerror=null; this.src='https://placehold.co/150x150/e2e8f0/000000?text=Brak+zdjƒôcia';">
                    </div>
                    <h3 class="text-2xl font-semibold text-gray-900">${chicken.name}</h3>
                    <p class="text-gray-600 mt-1">
                        <span class="font-bold">Gatunek:</span> ${chicken.species}
                    </p>
                    ${dobOrDeathInfo}
                    <p class="text-gray-600">
                        <span class="font-bold">Nr. obrƒÖczki:</span> ${chicken.ringNumber}
                    </p>
                `;
                container.appendChild(card);
            });
        }

        /**
         * Filters the chicken list based on the search input.
         */
        function filterChickens() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const filteredChickens = sortedChickens.filter(chicken => {
                const nameMatch = chicken.name.toLowerCase().includes(query);
                const speciesMatch = chicken.species.toLowerCase().includes(query);
                const dobMatch = chicken.dob.toLowerCase().includes(query);
                return nameMatch || speciesMatch || dobMatch;
            });
            renderChickens(filteredChickens, 'chicken-list');
        }
        
        /**
         * Generates a multi-page PDF from the main content section, with page breaks, header, and footer.
         */
        async function generatePDF() {
            const doc = new window.jspdf.jsPDF("p", "mm", "a4");
            const pdfWidth = doc.internal.pageSize.getWidth();
            const pdfHeight = doc.internal.pageSize.getHeight();
            const margin = 10;
            let pageNumber = 1;
            
            // Get current counts from the main app
            const totalCount = document.getElementById('total-count').innerText;
            const chickenCount = document.getElementById('chicken-count').innerText;
            const roosterCount = document.getElementById('rooster-count').innerText;

            const chickenList = document.getElementById('chicken-list');
            const chickenCards = Array.from(chickenList.children);
            const cardsPerPage = 12;

            // Function to add header to a page
            const addHeader = (pageNumber) => {
                doc.setFontSize(13);
                doc.text(`Aktualna lista: ${totalCount} `, margin, margin + 5);
                doc.text(`Razem: ${totalCount} Kury: ${chickenCount}, Koguty: ${roosterCount}`, margin, margin + 12);
                doc.line(margin, margin + 15, pdfWidth - margin, margin + 15);
            };

            // Function to add footer to a page
            const addFooter = (pageNumber) => {
                doc.setFontSize(10);
                doc.text(`Generator PDF opracowany przez ‚Äî O5K4R_ TECHNOLOG | Strona nr. ${pageNumber}`, pdfWidth - margin, pdfHeight - margin - 2, { align: 'right' });
            };

            // Loop through the cards and generate pages
            for (let i = 0; i < chickenCards.length; i += cardsPerPage) {
                // If not the first page, add a new one
                if (i > 0) {
                    doc.addPage();
                    pageNumber++;
                }

                // Add header and footer to the new page
                addHeader(pageNumber);
                addFooter(pageNumber);

                // Create a temporary container for the cards on this page
                const tempDiv = document.createElement('div');
                
                const cardsToProcess = chickenCards.slice(i, i + cardsPerPage);
                cardsToProcess.forEach(card => tempDiv.appendChild(card.cloneNode(true)));

                // Set styles to make sure PDF rendering is correct
                tempDiv.style.display = 'grid';
                tempDiv.style.gridTemplateColumns = 'repeat(3, minmax(0, 1fr))';
                tempDiv.style.gap = '1.5rem';
                tempDiv.style.paddingTop = '20mm'; // Space for the header
                document.body.appendChild(tempDiv);
                
                const canvas = await html2canvas(tempDiv, {
                    scale: 2, // Improve image quality
                    logging: false,
                    useCORS: true,
                    allowTaint: true
                });

                document.body.removeChild(tempDiv);

                const imgData = canvas.toDataURL('image/jpeg');
                doc.addImage(imgData, 'JPEG', margin, margin + 20, pdfWidth - 2 * margin, (pdfWidth - 2 * margin) * (canvas.height / canvas.width));
            }

            // Save the PDF
            doc.save('lista-kur.pdf');
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Sort chickens by date of birth, from newest to oldest. Unknown dates go to the end.
            sortedChickens = allChickens.map(chicken => {
                return {
                    ...chicken,
                    isRooster: chicken.name.toLowerCase().includes('kogut'),
                    parsedDob: parseDate(chicken.dob)
                };
            }).sort((a, b) => {
                // Koguty zawsze na poczƒÖtku, sortowanie wed≈Çug daty od najstarszych do najm≈Çodszych
                if (a.isRooster && b.isRooster) {
                    return a.parsedDob.getTime() - b.parsedDob.getTime();
                }
                if (a.isRooster && !b.isRooster) {
                    return -1;
                }
                if (!a.isRooster && b.isRooster) {
                    return 1;
                }
                // Kury sortowane od najm≈Çodszych do najstarszych
                return b.parsedDob.getTime() - a.parsedDob.getTime();
            });

            renderChickens(sortedChickens, 'chicken-list');
            renderChickens(deceasedChickens, 'deceased-chicken-list', true);

            document.getElementById('search-input').addEventListener('input', filterChickens);
            document.getElementById('download-pdf').addEventListener('click', generatePDF);
        });
    </script>
</body>
</html>
